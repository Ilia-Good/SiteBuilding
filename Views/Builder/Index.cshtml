@{
    ViewData["Title"] = "Builder";
    var initialSlug = (Context.Request.Query["slug"].ToString() ?? string.Empty).Trim().ToLowerInvariant();
}

<div class="dnd-builder">
    <aside class="dnd-sidebar">
        <h2>Добавить блок</h2>

        <label class="dnd-label" for="siteSlug">Slug сайта</label>
        <input id="siteSlug" class="dnd-input" value="@initialSlug" placeholder="my-site" />

        <div class="dnd-buttons">
            <button type="button" data-add="heading">Heading</button>
            <button type="button" data-add="text">Text</button>
            <button type="button" data-add="image">Image</button>
            <button type="button" data-add="contactForm">ContactForm</button>
        </div>

        <div id="saveStatus" class="dnd-status">Черновик не сохранен</div>

        <h3>JSON</h3>
        <pre id="jsonOutput" class="dnd-json">[]</pre>
    </aside>

    <main class="dnd-canvas-wrap">
        <h2>Canvas</h2>
        <div id="canvas" class="dnd-canvas"></div>
    </main>
</div>

@section Styles {
    <style>
        .dnd-builder {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 16px;
            min-height: 70vh;
        }

        .dnd-sidebar,
        .dnd-canvas-wrap {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
        }

        .dnd-buttons {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .dnd-buttons button {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px;
            background: #f9fafb;
        }

        .dnd-label {
            display: block;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .dnd-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .dnd-status {
            font-size: 12px;
            color: #4b5563;
            margin-bottom: 10px;
        }

        .dnd-json {
            min-height: 180px;
            font-size: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            background: #f9fafb;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .dnd-canvas {
            min-height: 420px;
            border: 1px dashed #9ca3af;
            border-radius: 8px;
            padding: 12px;
            background: #f8fafc;
        }

        .dnd-block {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: #fff;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
        }

        .dnd-block.dragging {
            opacity: 0.45;
        }

        .dnd-block.drop-target {
            outline: 2px solid #2563eb;
        }

        .dnd-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #374151;
        }

        .dnd-delete {
            border: none;
            background: transparent;
            color: #b91c1c;
        }

        .dnd-field {
            display: grid;
            gap: 4px;
            margin-bottom: 8px;
        }

        .dnd-field input,
        .dnd-field textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
        }

        @@media (max-width: 900px) {
            .dnd-builder {
                grid-template-columns: 1fr;
            }
        }
    </style>
}

@section Scripts {
    <script>
        (() => {
            const siteSlugInput = document.getElementById('siteSlug');
            const canvas = document.getElementById('canvas');
            const jsonOutput = document.getElementById('jsonOutput');
            const saveStatus = document.getElementById('saveStatus');
            const addButtons = document.querySelectorAll('[data-add]');

            let blocks = [];
            let nextId = 1;
            let draggedId = null;
            let saveTimer = null;

            const defaultPropsByType = {
                heading: () => ({ text: 'Hello' }),
                text: () => ({ text: 'My site' }),
                image: () => ({ src: 'https://placehold.co/800x320?text=Image', alt: 'Image' }),
                contactForm: () => ({ title: 'Contact us', buttonText: 'Send' })
            };

            addButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    addBlock(btn.dataset.add);
                });
            });

            siteSlugInput.addEventListener('input', () => {
                scheduleSave();
            });

            function addBlock(type) {
                const createProps = defaultPropsByType[type];
                if (!createProps) return;

                blocks.push({
                    id: nextId++,
                    type,
                    props: createProps()
                });

                render();
                scheduleSave();
            }

            function removeBlock(id) {
                blocks = blocks.filter((b) => b.id !== id);
                render();
                scheduleSave();
            }

            function updateBlockProp(id, key, value) {
                const block = blocks.find((b) => b.id === id);
                if (!block) return;
                block.props[key] = value;
                renderJson();
                scheduleSave();
            }

            function render() {
                canvas.innerHTML = '';

                if (blocks.length === 0) {
                    const empty = document.createElement('div');
                    empty.textContent = 'Canvas пуст. Добавьте блоки слева.';
                    empty.style.color = '#6b7280';
                    canvas.appendChild(empty);
                }

                blocks.forEach((block) => {
                    const blockEl = document.createElement('div');
                    blockEl.className = 'dnd-block';
                    blockEl.draggable = true;
                    blockEl.dataset.id = String(block.id);

                    blockEl.addEventListener('dragstart', (event) => {
                        draggedId = block.id;
                        blockEl.classList.add('dragging');
                        event.dataTransfer.effectAllowed = 'move';
                        event.dataTransfer.setData('text/plain', String(block.id));
                    });

                    blockEl.addEventListener('dragend', () => {
                        blockEl.classList.remove('dragging');
                        clearDropTargets();
                    });

                    blockEl.addEventListener('dragover', (event) => {
                        event.preventDefault();
                        event.dataTransfer.dropEffect = 'move';
                        clearDropTargets();
                        blockEl.classList.add('drop-target');
                    });

                    blockEl.addEventListener('dragleave', () => {
                        blockEl.classList.remove('drop-target');
                    });

                    blockEl.addEventListener('drop', (event) => {
                        event.preventDefault();
                        const targetId = block.id;
                        reorderBlocks(draggedId, targetId);
                        clearDropTargets();
                    });

                    const head = document.createElement('div');
                    head.className = 'dnd-head';
                    head.innerHTML = `<span>${block.type} #${block.id}</span>`;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'dnd-delete';
                    deleteBtn.textContent = 'Удалить';
                    deleteBtn.addEventListener('click', () => removeBlock(block.id));
                    head.appendChild(deleteBtn);
                    blockEl.appendChild(head);

                    renderEditorFields(blockEl, block);
                    renderCanvasPreview(blockEl, block);

                    canvas.appendChild(blockEl);
                });

                renderJson();
            }

            function renderEditorFields(blockEl, block) {
                if (block.type === 'heading' || block.type === 'text') {
                    blockEl.appendChild(createTextField(block.id, 'text', 'Text', block.props.text || ''));
                }

                if (block.type === 'image') {
                    blockEl.appendChild(createTextField(block.id, 'src', 'Image src', block.props.src || ''));
                    blockEl.appendChild(createTextField(block.id, 'alt', 'Alt', block.props.alt || ''));
                }

                if (block.type === 'contactForm') {
                    blockEl.appendChild(createTextField(block.id, 'title', 'Title', block.props.title || ''));
                    blockEl.appendChild(createTextField(block.id, 'buttonText', 'Button text', block.props.buttonText || ''));
                }
            }

            function createTextField(blockId, key, label, value) {
                const wrap = document.createElement('label');
                wrap.className = 'dnd-field';

                const labelEl = document.createElement('span');
                labelEl.textContent = label;
                wrap.appendChild(labelEl);

                const input = document.createElement('input');
                input.value = value;
                input.addEventListener('input', () => updateBlockProp(blockId, key, input.value));
                wrap.appendChild(input);

                return wrap;
            }

            function renderCanvasPreview(blockEl, block) {
                const preview = document.createElement('div');

                if (block.type === 'heading') {
                    preview.innerHTML = `<h3>${escapeHtml(block.props.text || '')}</h3>`;
                }

                if (block.type === 'text') {
                    preview.innerHTML = `<p>${escapeHtml(block.props.text || '')}</p>`;
                }

                if (block.type === 'image') {
                    const src = block.props.src || '';
                    const alt = block.props.alt || '';
                    preview.innerHTML = `<img src="${escapeHtml(src)}" alt="${escapeHtml(alt)}" style="max-width:100%;height:auto;border-radius:6px;">`;
                }

                if (block.type === 'contactForm') {
                    const title = block.props.title || 'Contact us';
                    const buttonText = block.props.buttonText || 'Send';
                    preview.innerHTML = `
                        <div>
                            <strong>${escapeHtml(title)}</strong>
                            <div style="margin-top:6px;display:grid;gap:6px;">
                                <input disabled placeholder="Name" />
                                <input disabled placeholder="Email" />
                                <textarea disabled placeholder="Message"></textarea>
                                <button type="button" disabled>${escapeHtml(buttonText)}</button>
                            </div>
                        </div>`;
                }

                blockEl.appendChild(preview);
            }

            function reorderBlocks(fromId, toId) {
                if (!fromId || !toId || fromId === toId) return;

                const fromIndex = blocks.findIndex((b) => b.id === fromId);
                const toIndex = blocks.findIndex((b) => b.id === toId);
                if (fromIndex < 0 || toIndex < 0) return;

                const [moved] = blocks.splice(fromIndex, 1);
                blocks.splice(toIndex, 0, moved);

                render();
                scheduleSave();
            }

            function clearDropTargets() {
                canvas.querySelectorAll('.dnd-block.drop-target').forEach((el) => {
                    el.classList.remove('drop-target');
                });
            }

            function renderJson() {
                jsonOutput.textContent = JSON.stringify(blocks, null, 2);
            }

            function scheduleSave() {
                if (saveTimer) clearTimeout(saveTimer);
                saveTimer = setTimeout(saveToServer, 500);
            }

            async function saveToServer() {
                const slug = makeSlug(siteSlugInput.value);
                if (!slug) {
                    saveStatus.textContent = 'Для сохранения введите slug сайта';
                    return;
                }

                saveStatus.textContent = `Сохраняю (${new Date().toLocaleTimeString()})...`;
                try {
                    const response = await fetch(`/api/builder/state/${encodeURIComponent(slug)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ state: { blocks } })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    saveStatus.textContent = `Сохранено (${new Date().toLocaleTimeString()})`;
                } catch (error) {
                    saveStatus.textContent = `Ошибка сохранения: ${error.message || error}`;
                }
            }

            async function loadFromServer() {
                const slug = makeSlug(siteSlugInput.value);
                if (!slug) {
                    render();
                    return;
                }

                try {
                    const response = await fetch(`/api/builder/state/${encodeURIComponent(slug)}`);
                    if (response.ok) {
                        const state = await response.json();
                        if (state && Array.isArray(state.blocks)) {
                            blocks = state.blocks
                                .filter((b) => b && typeof b.type === 'string')
                                .map((b) => ({
                                    id: Number(b.id) || nextId++,
                                    type: b.type,
                                    props: b.props && typeof b.props === 'object' ? b.props : {}
                                }));

                            const maxId = blocks.reduce((acc, b) => Math.max(acc, b.id), 0);
                            nextId = Math.max(nextId, maxId + 1);
                        }
                    }
                } catch {
                    // Ignore and start empty.
                }

                render();
            }

            function makeSlug(value) {
                return (value || '')
                    .toLowerCase()
                    .trim()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
            }

            function escapeHtml(value) {
                const div = document.createElement('div');
                div.textContent = value;
                return div.innerHTML;
            }

            loadFromServer();
        })();
    </script>
}
